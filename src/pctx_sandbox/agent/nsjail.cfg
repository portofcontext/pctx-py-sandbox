name: "pctx-sandbox-worker"

# Mode: LISTEN creates a server that spawns isolated processes per connection
mode: ONCE

# Hostname inside the jail
hostname: "sandbox"

# Working directory
cwd: "/tmp"

# Time limit (wall-clock) in seconds - will be overridden per execution
time_limit: 30

# Enable Linux namespaces for isolation
clone_newnet: false  # Network namespace (false to allow network if needed)
clone_newuser: false # User namespace (requires root or newuidmap/newgidmap)
clone_newns: true    # Mount namespace
clone_newpid: true   # PID namespace
clone_newipc: true   # IPC namespace
clone_newuts: true   # UTS namespace (hostname)
clone_newcgroup: false # Cgroup namespace

# Keep all environment variables (needed for Python)
keep_env: true

# Resource limits (rlimits)
rlimit_as_type: HARD
rlimit_as: 1024  # Address space: 1GB (will be overridden based on memory_mb)

rlimit_cpu_type: HARD
rlimit_cpu: 900  # CPU time: 15 minutes max

rlimit_nofile_type: HARD
rlimit_nofile: 1024  # Max open files

rlimit_nproc_type: HARD
rlimit_nproc: 64  # Max processes

rlimit_fsize_type: HARD
rlimit_fsize: 1024  # Max file size: 1GB

# Mount essential filesystems
mount {
  src: "/lib"
  dst: "/lib"
  is_bind: true
  rw: false
}

mount {
  src: "/lib64"
  dst: "/lib64"
  is_bind: true
  rw: false
  mandatory: false  # Not all systems have lib64
}

mount {
  src: "/usr"
  dst: "/usr"
  is_bind: true
  rw: false
}

mount {
  src: "/bin"
  dst: "/bin"
  is_bind: true
  rw: false
}

mount {
  src: "/sbin"
  dst: "/sbin"
  is_bind: true
  rw: false
}

# Mount /tmp as read-write for temporary files
mount {
  src: "/tmp"
  dst: "/tmp"
  is_bind: true
  rw: true
}

# Mount /proc (required for Python and many programs)
mount {
  src: "/proc"
  dst: "/proc"
  fstype: "proc"
  rw: false
}

# Mount /dev (minimal)
mount {
  dst: "/dev"
  fstype: "tmpfs"
  rw: true
  options: "size=4m,mode=755"
}

# Essential /dev nodes - bind mount from host
mount {
  src: "/dev/null"
  dst: "/dev/null"
  is_bind: true
  rw: true
}

mount {
  src: "/dev/zero"
  dst: "/dev/zero"
  is_bind: true
  rw: true
}

mount {
  src: "/dev/urandom"
  dst: "/dev/urandom"
  is_bind: true
  rw: true
}

# Use cgroupv2 (modern unified cgroup hierarchy, available on recent kernels)
# Requires root but works properly with modern Linux distributions
use_cgroupv2: true
